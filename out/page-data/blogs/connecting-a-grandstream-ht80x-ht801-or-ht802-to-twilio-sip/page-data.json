{"componentChunkName":"component---src-templates-blog-post-js","path":"/blogs/connecting-a-grandstream-ht80x-ht801-or-ht802-to-twilio-sip","result":{"data":{"contentfulBlogs":{"id":"781fdadf-0468-51f7-83e6-71bbce84a6c1","title":"Connecting a Grandstream HT80X (HT801 or HT802) to Twilio SIP","slug":"connecting-a-grandstream-ht80x-ht801-or-ht802-to-twilio-sip","featureImage":{"gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=320&h=180&q=50&fm=webp 320w,\nhttps://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=640&h=360&q=50&fm=webp 640w,\nhttps://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=1280&h=720&q=50&fm=webp 1280w","sizes":"(min-width: 1280px) 1280px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=1280&h=720&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=320&h=180&fl=progressive&q=50&fm=jpg 320w,\nhttps://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=640&h=360&fl=progressive&q=50&fm=jpg 640w,\nhttps://images.ctfassets.net/o4gibwve10tr/5e54w5WprkodnaJyjk15dc/f4ca8c28e9c51332108e3b780c6f23d3/template.jpg?w=1280&h=720&fl=progressive&q=50&fm=jpg 1280w","sizes":"(min-width: 1280px) 1280px, 100vw"}},"layout":"constrained","backgroundColor":"#1868d8","width":1280,"height":720}},"description":{"childMarkdownRemark":{"html":"<h1>The Inspiration</h1>\n<p>I'm diving into all of Twilio's products and trying to learn as much as I can about them. The best way I learn is by actually doing it and trying to build it myself. My focus on this project was learning about <a href=\"https://en.wikipedia.org/wiki/SIP_trunking\">SIP Trunking</a>. It seemed pretty straightforward, but as always the devil is in the details and there are always nuances to learn about everything.</p>\n<h1>Future Goal</h1>\n<p>I wanted to get an Analog Telephone Adapter, so I can hook up up an old landline telephone with an obnoxious bell and have it wake me up like an alarm clock ‚è∞.</p>\n<h1>Picking The Hardware</h1>\n<p>There's a bunch of Analog Telephone Adatpers (ATA) out there. I was also looking at the Cisco ATA 191 but ultimately settled on the Grandstream HT801 because it was less than $20 from someone on eBay and I found these <a href=\"https://nickbusey.com/article/2020-05-04-twilio-grandstream/\">instructions from Nick Busey</a> on how to set up the device specifically with Twilio SIP. I thought that because it was a recent post, that I wouldn't have much difficulty trying to configure it. Here's the <a href=\"https://amzn.to/3eh0pvG\">Amazon link</a>.</p>\n<h1>Getting Started</h1>\n<p>I had orginally followed Nick's instructions but there were some drawbacks. I had trouble with inbound calls and also triggering calls with the REST API.</p>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/5vMqmyuNhvIWo9EVLcHc6T/89c752338f4640dbdba1307449d94a67/ht801.jpeg\" alt=\"Twilio SIP ht801\"></p>\n<h1>Steps</h1>\n<ol>\n<li><a href=\"https://www.twilio.com/docs/sip-trunking/ip-addresses\">Open ports in your router's firewall</a></li>\n<li>Configure Outbound Calls</li>\n<li>Configure Inbound Calls</li>\n<li>Configure the Grandstream device</li>\n</ol>\n<p>Unfortunately, in Nick's use-case, he only needed outbound calling, which made the phone only half as useful for me haha. I recognized his name as the creator/maintainer of the <a href=\"https://homelabos.com/\">HomeLabOS project</a>. So I knew I could find him on the <a href=\"https://homelabos.zulipchat.com/login/\">HomeLabOS Zulip Chat</a> and asked him a few questions on if he was able to get outbound AND inbound calling working. He graciously answered a few of my questions. Unfortunately, he doesn't use the device anymore and didn't look into getting inbound calls more.</p>\n<p>So, at this point I was able to configure the device and have outbound calling going, but I needed more. So, I logged a Service Ticket with Twilio. Again, this was a good excuse to learn more about Twilio by using the products like Customer Support.</p>\n<p>A customer service rep was able to help me troubleshoot the issue and taught me a few things along the way, like this... ~~</p>\n<h2><strong>Pro Tip</strong>:</h2>\n<p>You can download the PCAP file and explore it with WireShark to explore the headers and see what's going on during the connection process.</p>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/4CU6J6FmWG9p1htwpLGfnd/555cdcb916537e24e7d5a20b42f1420c/Screen_Shot_2021-03-06_at_9.36.52_PM.png\" alt=\"Twilio SIP Console PCAP Download\"></p>\n<p>During the connection process for incoming calls, he explained that the Contact section in the Header was trying to return the local IP address of the ATA box instead of my public IP address of my home internet connection -- so something was literally getting lost in translation, well the <em>Network Address Translation</em> (NAT).</p>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/1PRNejlAqqLlX72Rw3h1Pm/90a77a6889ef174c0dd1148ba8548923/Twilio_SIP_Support_Screen_Shot.png\" alt=\"Twilio SIP Support Screen Shot\"></p>\n<p>At first, I ended up hard-coding my public IP address in this section of the Grandstream configuration like this:</p>\n<p><code class=\"language-text\">Use NAT IP: 123.456.78.90</code></p>\n<br />\n<p>However, there were some issues if you put in your Public IP address -- better hope it doesn't change! This \"hack\" overrides the internal IP address that was being returned in the Header and allows incoming calls to come in. I tried to use a Dynamic DNS address but the field only allowed enough digits for an IP address.</p>\n<p>With the first configuration, I was having trouble receiving calls via a REST API command. Investigating into the PCAP file helped me troubleshoot. After taking a step back, I ended up figuring the right configuration!</p>\n<h1>Create a SIP Trunk</h1>\n<p>Name it something and add an <code class=\"language-text\">Origination URL</code>: <code class=\"language-text\">sip:username@your_domain.sip.us1.twilio.com</code></p>\n<h1>Configure a SIP Domain in Twilio Programmable Voice</h1>\n<p>make the <code class=\"language-text\">SIP URI</code> something easy for you to remember. This will be the url of the <code class=\"language-text\">Primary SIP Server</code> on your Grandstream box. With that, you'll have to add a value to the <code class=\"language-text\">IP Access Control List</code> and a <code class=\"language-text\">Credential List</code>. The username/password you put in your <code class=\"language-text\">Credential List</code> will be the <code class=\"language-text\">SIP User ID</code> and the <code class=\"language-text\">Authenticate ID</code> on your Grandstream box.</p>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/3PhjpqA93wUNsZuwtAYRq7/2e955afcc78a2f6b8936d2936f79d5ef/twilio_wake_up_call_-_SIP_domain_configuration.png\" alt=\"twilio wake up call - SIP domain configuration\"></p>\n<h1>Create a Credential</h1>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/6UFXmIFSYs9UWA5NHyxBXH/3c430249d1de1494a0cecf8950381116/Twilio_Wake_Up_Call_-_Create_a_Credential.png\" alt=\"Twilio Wake Up Call - Create a Credential\"></p>\n<h1>Configure Outgoing Calls with a TwiML Bin</h1>\n<p>While you're here, scroll down and add a TwiML Bin for when <code class=\"language-text\">A Call Comes In</code> so you can make outgoing calls.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Response</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Dial</span> <span class=\"token attr-name\">callerId</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>+14151234567<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>{{#e164}}{{To}}{{/e164}}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Dial</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Response</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/2lskbw5hNGL8krdI7eycXh/cdca8645356f3265124beac269f06ed2/Twilio_Wake_Up_Call_-_Outgoing_Call_Configuration.png\" alt=\"Twilio Wake Up Call - Outgoing Call Configuration\"></p>\n<h1>SIP Registration</h1>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/4rMReu6moj5v0qwb3zgy5B/e6216b1238527be6ea04706f2ae011c7/Twilio_Wake_Up_Call_-_SIP_Registration.png\" alt=\"Twilio Wake Up Call - SIP Registration\"></p>\n<h1>Screenshot of Grandstream Configuration</h1>\n<p>When I was looking for help on the configuration, I kept seeing sections but wanted the FULL image. So, here's mine, in its entirety.</p>\n<p>Update the following fields:</p>\n<ul>\n<li>Primary SIP Server: your_domain.sip.us1.twilio.com</li>\n<li>SIP User ID</li>\n<li>Authenticate ID</li>\n<li>Authenticate Password</li>\n<li>SIP REGISTER Contact Uses: WAN Address</li>\n<li>Check SIP User ID for incoming INVITE</li>\n<li>Dial Plan Prefix: +</li>\n</ul>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/53eDJwKJymDedxUyHBJq8R/5103801c7ec19c344e1718770a41daa6/Grandstream_Device_Configuration_Updated.png\" alt=\"Grandstream Device Configuration Updated\"></p>\n<h1>Confirm SIP Registration</h1>\n<p>You'll see your username and \"Registered\" on the Port Status line.</p>\n<p><img src=\"//images.ctfassets.net/o4gibwve10tr/6GJlfNCyE6VFwjFgMvF0vN/397a23d05568bc620bbd799fb8b59ea7/Screen_Shot_2021-03-30_at_8.48.33_PM.png\" alt=\"Twilio Wake Up Call - Confirm Registration\"></p>\n<h1>Configure Incoming Calls With a TwiML Bin</h1>\n<p>As outlined <a href=\"https://www.twilio.com/docs/voice/api/sip-registration#receiving-calls-on-your-registered-sip-endpoint\">here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Response</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Dial</span> <span class=\"token attr-name\">answerOnBridge</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Sip</span><span class=\"token punctuation\">></span></span>username@your_domain.sip.twilio.com<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Sip</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Dial</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Response</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Go to your phone number in the Numbers Tab and click on it.\n<code class=\"language-text\">When a Comes In</code>: run the TwiML Bin you just created above.</p>\n<h1>Next Steps</h1>\n<p>It'd be fun to setup a PBX server and have IP Phones with different extensions for each room in my house, but it's probably extreme overkill for what I need. Here's how I incorporate the ATA landline into a new type of <a href=\"https://michaellunzer.com/projects/home-assistant-wake-up-alarm-with-a-phone-call\">Wake Up Call Alarm project</a>.</p>"}},"createdAt":"2021-03-07T06:26:00.928Z"},"contentfulSiteInformation":{"siteUrl":"https://michaellunzer.com","twiteerHandle":"@michaellunzer"}},"pageContext":{"slug":"connecting-a-grandstream-ht80x-ht801-or-ht802-to-twilio-sip"}},"staticQueryHashes":["1194089924","1242132861","1746898652","1794736483","425184262","603260039","868401008"]}